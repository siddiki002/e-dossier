<div class="personal-information-entry-container">
    <div style="width: 100%; display: flex; justify-content: flex-end;">
        <button matButton="filled" [disabled]="!personalInformationForm.valid" (click)="saveOfficerInformation()">Save Information</button>
        <input
            type="file"
            #fileInput
            (change)="onFileSelected($event)"
            accept="image/*"
            style="display: none"
        />
    </div>
    <div class="content">
        <div style="padding: 1rem; width: 30%; background-color: black; max-height: fit-content;">
            <sailor-list (onSailorSelection)="onOfficerSelection($event)" [sailors]="sailorsInClass" [showSearchBar]="true" [classTitle]="classDetails?.name" [allowSailorSelection]="true"></sailor-list>
        </div>

        <!-- Family Members Table - Only show if there are family members -->
        <div *ngIf="hasFamilyMembers" style="width: 25%; padding: 1rem; background-color: #f5f5f5; max-height: fit-content;">
            <h3>Family Members</h3>
            <table mat-table [dataSource]="familyArray.controls" class="family-table">
                <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef>Name</th>
                    <td mat-cell *matCellDef="let element; let i = index" 
                        [class.selected-row]="selectedFamilyMemberIndex === i"
                        (click)="selectFamilyMember(i)">
                        {{element.get('name')?.value || 'N/A'}}
                    </td>
                </ng-container>

                <ng-container matColumnDef="relation">
                    <th mat-header-cell *matHeaderCellDef>Relation</th>
                    <td mat-cell *matCellDef="let element; let i = index"
                        [class.selected-row]="selectedFamilyMemberIndex === i"
                        (click)="selectFamilyMember(i)">
                        {{element.get('relation')?.value || 'N/A'}}
                    </td>
                </ng-container>

                <ng-container matColumnDef="cnic">
                    <th mat-header-cell *matHeaderCellDef>CNIC</th>
                    <td mat-cell *matCellDef="let element; let i = index"
                        [class.selected-row]="selectedFamilyMemberIndex === i"
                        (click)="selectFamilyMember(i)">
                        {{element.get('cnic')?.value || 'N/A'}}
                    </td>
                </ng-container>

                <ng-container matColumnDef="contactNumber">
                    <th mat-header-cell *matHeaderCellDef>Contact</th>
                    <td mat-cell *matCellDef="let element; let i = index"
                        [class.selected-row]="selectedFamilyMemberIndex === i"
                        (click)="selectFamilyMember(i)">
                        {{element.get('contactNumber')?.value || 'N/A'}}
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="family-row"></tr>
            </table>
        </div>

            <div [style.width]="hasFamilyMembers ? '40%' : '65%'">
                <div class="officer-image-container">
                    <div style="display: flex; justify-content: center; align-items: center;">
                        <button matButton="elevated" style="margin-bottom: 1rem;" (click)="fileInput.click()">Upload picture</button>
                    </div>
                    <img *ngIf="officerImageUrl; else defaultImage" [src]="officerImageUrl" alt="Navy Icon" class="officer-image"/>
                    <ng-template #defaultImage>
                        <img src="/default-image.png" alt="Navy Icon" class="officer-image"/>
                    </ng-template>
                </div>
                <form [formGroup]="personalInformationForm" class="data-entry-form">
                    <mat-form-field appearance="outline">
                        <mat-label>Sailor ID</mat-label>
                        <input matInput formControlName="sailorId" readonly/>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Sailor Name</mat-label>
                        <input matInput formControlName="name" readonly/>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Father Name</mat-label>
                        <input matInput formControlName="fatherName" />
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>CNIC</mat-label>
                        <mat-hint>XXXXX-XXXXXXX-X</mat-hint>
                        <input matInput formControlName="cnic" />
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Marital Status</mat-label>
                        <mat-select formControlName="maritalStatus">
                            <mat-option value="single">Single</mat-option>
                            <mat-option value="married">Married</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Date of Birth</mat-label>
                        <input matInput formControlName="dateOfBirth" [matDatepicker]="picker" readonly (click)="picker.open()"/>
                        <mat-hint>MM/DD/YYYY</mat-hint>
                        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Date of enrollment</mat-label>
                        <input matInput formControlName="dateOfEnrollment" [matDatepicker]="enrollmentPicker" readonly (click)="enrollmentPicker.open()"/>
                        <mat-hint>MM/DD/YYYY</mat-hint>
                        <mat-datepicker-toggle matIconSuffix [for]="enrollmentPicker"></mat-datepicker-toggle>
                        <mat-datepicker #enrollmentPicker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Blood Group</mat-label>
                        <mat-select formControlName="bloodGroup">
                            <mat-option value="A+">A+</mat-option>
                            <mat-option value="A-">A-</mat-option>
                            <mat-option value="B+">B+</mat-option>
                            <mat-option value="B-">B-</mat-option>
                            <mat-option value="O+">O+</mat-option>
                            <mat-option value="O-">O-</mat-option>
                            <mat-option value="AB+">AB+</mat-option>
                            <mat-option value="AB-">AB-</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Contact Number</mat-label>
                        <input matInput formControlName="contactNumber" />
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Rate</mat-label>
                        <input matInput formControlName="rate" readonly/>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Permanent Address</mat-label>
                        <input matInput formControlName="permanentAddress" />
                    </mat-form-field>
                </form>
                <h2>Next of Kin (NOK) Details</h2>
                <form [formGroup]="emergencyContactFormGroup" class="data-entry-form">
                    <mat-form-field appearance="outline">
                        <mat-label>CNIC</mat-label>
                        <mat-hint>XXXXX-XXXXXXX-X</mat-hint>
                        <input matInput formControlName="cnic" />
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Contact Number</mat-label>
                        <input matInput formControlName="contactNumber" />
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Name</mat-label>
                        <input matInput formControlName="name" />
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Relation</mat-label>
                        <mat-select formControlName="relation">
                            <mat-option value="father">Father</mat-option>
                            <mat-option value="mother">Mother</mat-option>
                            <mat-option value="brother">Brother</mat-option>
                            <mat-option value="sister">Sister</mat-option>
                            <mat-option value="wife">Wife</mat-option>
                        </mat-select>
                    </mat-form-field>
                </form>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-block: 1rem;">
                    <h2>Additional Family Information</h2>
                    <button matButton="elevated" (click)="addFamilyMember()">Add Family Member +</button>
                </div>
                
                <!-- Family Member Detail Form - Only show if a family member is selected -->
                <div *ngIf="selectedFamilyMemberForm" [formGroup]="selectedFamilyMemberForm" class="data-entry-form" style="margin-bottom: 1rem;">
                    <mat-form-field appearance="outline">
                        <mat-label>Name</mat-label>
                        <input matInput formControlName="name" />
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Relation</mat-label>
                        <mat-select formControlName="relation">
                            <mat-option value="father">Father</mat-option>
                            <mat-option value="mother">Mother</mat-option>
                            <mat-option value="brother">Brother</mat-option>
                            <mat-option value="sister">Sister</mat-option>
                            <mat-option value="wife">Wife</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>CNIC</mat-label>
                        <input matInput formControlName="cnic" />
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Contact Number</mat-label>
                        <input matInput formControlName="contactNumber" />
                    </mat-form-field>

                    <button matButton="elevated" (click)="removeFamilyMember(selectedFamilyMemberIndex)">Remove This Member</button>
                </div>

                <!-- Show message when no family member is selected -->
                <div *ngIf="hasFamilyMembers && !selectedFamilyMemberForm" style="text-align: center; padding: 2rem; color: #666;">
                    <p>Select a family member from the table to edit their details</p>
                </div>
            </div>
    </div>
</div>

<ng-template #successDialog>
        <h2 mat-dialog-title>Success</h2>
        <mat-dialog-content style="text-align: center; align-items: center;">
            <p>Officer information saved successfully!</p>
            <div class="tick-animate">
                <mat-icon>check_circle</mat-icon>
            </div>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button matButton="elevated" color="primary" (click)="closeSuccessDialog()">OK</button>
        </mat-dialog-actions>
</ng-template>